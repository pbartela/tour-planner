name: Testing

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # Allow manual trigger

jobs:
  # Lint and Type Check
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Check TypeScript types
        run: npx tsc --noEmit

  # Vitest Unit Tests
  vitest:
    name: Vitest Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit

      - name: Run coverage
        run: npm run test:unit:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # Playwright E2E Tests (optional - requires Supabase)
  playwright:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Run tests on multiple browsers
        project: [chromium, firefox]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for Supabase secrets
        id: check-secrets
        run: |
          if [ -n "${{ secrets.PUBLIC_SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "Skipping E2E tests - Supabase secrets not configured"
          fi

      - name: Install Playwright Browsers
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: npx playwright install --with-deps ${{ matrix.project }}

      - name: Create .env file
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          cat > .env << EOF
          PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          PUBLIC_DEFAULT_LOCALE=en-US
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EOF

      - name: Run Playwright tests
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: npx playwright test --project=${{ matrix.project }}
        env:
          CI: true
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.project }}
          path: playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-videos-${{ matrix.project }}
          path: test-results/
          retention-days: 7

  # Chromatic Visual Regression Tests (optional)
  chromatic:
    name: Chromatic Visual Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for Chromatic

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for Chromatic token
        id: check-chromatic
        run: |
          if [ -n "${{ secrets.CHROMATIC_PROJECT_TOKEN }}" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
          else
            echo "has_token=false" >> $GITHUB_OUTPUT
            echo "Skipping Chromatic - token not configured"
          fi

      - name: Run Chromatic
        if: steps.check-chromatic.outputs.has_token == 'true'
        uses: chromaui/action@latest
        with:
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          buildScriptName: build-storybook
          onlyChanged: true
          exitZeroOnChanges: true
          autoAcceptChanges: main
        continue-on-error: true

  # Smoke Tests (runs after deployment, optional - requires Supabase)
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for Supabase secrets
        id: check-secrets
        run: |
          if [ -n "${{ secrets.PUBLIC_SUPABASE_URL }}" ] && [ -n "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          else
            echo "has_secrets=false" >> $GITHUB_OUTPUT
            echo "Skipping smoke tests - Supabase secrets not configured"
          fi

      - name: Install Playwright
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: npx playwright install --with-deps chromium

      - name: Create .env file
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: |
          cat > .env << EOF
          PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY=${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
          PUBLIC_DEFAULT_LOCALE=en-US
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EOF

      - name: Run smoke tests
        if: steps.check-secrets.outputs.has_secrets == 'true'
        run: npx playwright test tests/e2e/smoke.spec.ts --project=chromium
        env:
          CI: true
        continue-on-error: true

      - name: Upload smoke test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: playwright-report/
          retention-days: 7