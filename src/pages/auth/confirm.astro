---
/**
 * PKCE Flow Server-Side Authentication Handler
 *
 * This endpoint handles magic link authentication using PKCE flow:
 * 1. User clicks magic link â†’ redirected with ?token_hash=...&type=magiclink
 * 2. Server extracts token_hash from query parameters
 * 3. Server calls supabase.auth.verifyOtp() to verify and create session
 * 4. Session established server-side via secure httpOnly cookies
 * 5. User redirected to intended destination
 *
 * Security: Tokens never exposed to client-side JavaScript
 * All authentication logic handled server-side for maximum security
 */
import { createSupabaseServerClient } from "@/db/supabase.client";
import { warn, secureError } from "@/lib/server/logger.service";
import { ENV } from "@/lib/server/env-validation.service";

export const prerender = false;

/**
 * Validates that a redirect path is safe and doesn't lead to an open redirect vulnerability.
 *
 * @param path - The path to validate
 * @returns True if the path is safe to redirect to, false otherwise
 */
function isValidRedirect(path: string): boolean {
  try {
    // Must start with / and not be a protocol-relative URL
    if (!path.startsWith("/") || path.startsWith("//")) {
      return false;
    }

    // Parse as URL with a dummy base to validate path structure
    // The URL constructor will throw if the path is invalid
    new URL(path, "http://dummy.local");

    // Ensure no protocol in the path (more precise than just checking for ':')
    // This prevents attacks like /javascript:alert(1) or /data:text/html,...
    if (path.match(/^[a-zA-Z][a-zA-Z0-9+.-]*:/)) {
      return false;
    }

    return true;
  } catch {
    return false;
  }
}

// Get query parameters
const url = new URL(Astro.request.url);
const tokenHash = url.searchParams.get("token_hash");
const type = url.searchParams.get("type");
const next = url.searchParams.get("next");

// Get locale from cookie or use default
const locale = Astro.cookies.get("locale")?.value || ENV.PUBLIC_DEFAULT_LOCALE;

// Determine redirect destination
let redirectPath = next || `/${locale}/`;

// Defense in depth: Validate redirect URL to prevent open redirect attacks
if (!isValidRedirect(redirectPath)) {
  warn("Invalid redirect detected, using default", { attemptedRedirect: redirectPath });
  redirectPath = `/${locale}/`;
}

// Validate required parameters
if (!tokenHash || !type) {
  secureError("Missing required parameters for magic link verification", {
    hasTokenHash: !!tokenHash,
    hasType: !!type,
  });
  return Astro.redirect(`/${locale}/auth/error?error=invalid_link`);
}

// Create Supabase client
const supabase = createSupabaseServerClient(Astro.request, Astro.cookies);

try {
  // Exchange the token hash for a session (PKCE magic link flow)
  // This validates the token server-side and creates a session
  const { data, error } = await supabase.auth.verifyOtp({
    token_hash: tokenHash,
    type: type as "signup" | "invite" | "magiclink" | "recovery" | "email_change" | "email",
  });

  if (error) {
    secureError("Token verification failed", error);
    return Astro.redirect(
      `/${locale}/auth/error?error=verification_failed&message=${encodeURIComponent(error.message)}`
    );
  }

  if (!data.session) {
    secureError("No session created after token verification");
    return Astro.redirect(`/${locale}/auth/error?error=session_failed`);
  }

  // Check if redirect path contains an invitation token
  // If so, automatically accept the invitation after successful login
  const inviteMatch = redirectPath.match(/\/invite\?token=([^&]+)/);
  if (inviteMatch && data.user) {
    const invitationToken = inviteMatch[1];

    try {
      // Call the accept_invitation database function
      const { data: tourId, error: acceptError } = await supabase.rpc("accept_invitation", {
        invitation_token: invitationToken,
        accepting_user_id: data.user.id,
      });

      if (acceptError) {
        // Log error but don't fail the login - let the user handle it on the invite page
        warn("Failed to auto-accept invitation after login", {
          error: acceptError,
          userId: data.user.id,
          token: invitationToken.substring(0, 8) + "...", // Log partial token for debugging
        });
        // Continue to invite page - the component will show appropriate error
      } else if (tourId) {
        // Successfully accepted - redirect directly to tour page
        return Astro.redirect(`/${locale}/tours/${tourId}`);
      }
    } catch (err) {
      warn("Error during auto-accept invitation", err);
      // Continue to invite page on error
    }
  }

  // Session is now established via cookies automatically by Supabase client
  // Redirect to the intended destination
  return Astro.redirect(redirectPath);
} catch (err) {
  secureError("Unexpected error during token verification", err);
  return Astro.redirect(`/${locale}/auth/error?error=unexpected_error`);
}
---
