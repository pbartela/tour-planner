# Privacy & Data Handling Policy

This document explains how Tour Planner handles user data, what information is visible to other users, and why.

## Table of Contents

- [Data Collection](#data-collection)
- [Email Visibility Model](#email-visibility-model)
- [Row-Level Security (RLS)](#row-level-security-rls)
- [Design Rationale](#design-rationale)
- [User Control](#user-control)
- [Data Retention](#data-retention)
- [Questions or Concerns](#questions-or-concerns)

## Data Collection

Tour Planner collects and stores the following user data:

### Required Data (Stored in `auth.users` and `profiles`)

- **Email Address**: Used for authentication, identification, and as fallback display name
- **User ID**: UUID generated by Supabase Auth
- **Created/Updated Timestamps**: For audit and data management

### Optional Profile Data

- **Display Name**: User-chosen name shown instead of email
- **Avatar URL**: Profile picture uploaded to Supabase Storage
- **Language Preference**: UI locale (e.g., en-US, pl-PL)
- **Theme Preference**: Light/dark/system theme choice
- **Onboarding Status**: Whether user completed initial setup

### Tour-Related Data

- **Tour Details**: Title, destination, dates, description, participant limit, vote threshold
- **Participation Records**: Which tours a user has joined, join timestamps
- **Comments**: User comments on tours
- **Votes**: User likes on tours
- **Invitations**: Sent/received invitation records with status

## Email Visibility Model

### Who Can See Your Email Address?

Your email address is visible to:

1. **Tour Co-Participants**: Anyone participating in the same tour as you
2. **Tour Owners**: Tour owners can see emails of all participants and invitees
3. **Comment Readers**: If you haven't set a display name, your email appears on comments

### Why Is Email Visible?

Email visibility serves several purposes:

1. **Identity Verification**: Ensures participants know who they're planning with
2. **Communication Fallback**: Allows participants to contact each other if needed
3. **Transparency**: Shows real identities in group planning contexts
4. **Display Fallback**: Used when display name is not set

### How to Reduce Email Exposure

Set a **Display Name** in your profile settings:
- Your display name will appear instead of email in most places
- Email still visible in participant lists but less prominent
- Comments show display name instead of email

**Note:** Email is always visible to tour co-participants regardless of display name.

### Detailed Visibility Breakdown

#### Participant Lists

When viewing tour participants:
- **Visible**: Display name (or email if no display name), avatar, join date
- **Who can see**: All tour participants
- **Protected by**: RLS (only co-participants can view)

#### Comments

When posting comments:
- **Visible**: Display name (or email if no display name), comment content, timestamp
- **Who can see**: All tour participants
- **Protected by**: RLS (only co-participants can view)

#### Invitations

When sending/receiving invitations:
- **Sender can see**: All invitee email addresses, invitation status
- **Recipient can see**: Own email, sender's email, invitation details
- **Who can see**: Tour owner and invitation recipient only
- **Protected by**: RLS (email-matching policy)

## Row-Level Security (RLS)

Tour Planner uses Supabase Row-Level Security (RLS) to protect your data at the database level.

### What Is RLS?

RLS is a database-level security mechanism that enforces who can read/write each row of data based on PostgreSQL policies. This means security is enforced even if application code has bugs.

### RLS Policies in Tour Planner

#### Tours Table

- **Read**: Only tour participants can view tour details
- **Create**: Any authenticated user can create tours
- **Update**: Only tour owner can modify tour
- **Delete**: Only tour owner can delete tour

#### Participants Table

- **Read**: Only users who are participants of the tour
- **Create**: Only tour owner can add participants (via invitation acceptance)
- **Delete**: Tour owner or the participant themselves

#### Comments Table

- **Read**: Only tour participants can read comments
- **Create**: Only tour participants can create comments
- **Update**: Only comment author can update their comment
- **Delete**: Only comment author can delete their comment

#### Votes Table

- **Read**: Tour participants (visibility controlled by `tour.are_votes_hidden`)
- **Create**: Only tour participants can vote
- **Delete**: Only voter can remove their vote

#### Invitations Table

- **Read**: Tour owner or invitation recipient (matched by email)
- **Create**: Only tour owner can send invitations
- **Update**: System only (status changes via database functions)
- **Delete**: Only tour owner can cancel invitations

### Security Guarantees

1. **No Cross-Tour Visibility**: You cannot see tours you're not participating in
2. **Owner-Only Actions**: Only tour owners can invite participants, modify tour details, or delete tours
3. **Author-Only Edits**: You can only edit/delete your own comments
4. **Email-Matched Access**: Invitations are only visible to the recipient email

## Design Rationale

### Why Not Hide Emails Completely?

Tour Planner is designed for **group trip planning with trusted individuals**. Key considerations:

1. **Trust Model**: Users invite people they know (friends, family, colleagues)
2. **Accountability**: Real identities prevent spam, abuse, and fake participants
3. **Communication**: Email visibility enables out-of-app communication if needed
4. **Transparency**: Group planning requires knowing who's actually involved

### Comparison to Other Platforms

Similar collaborative tools also show email addresses:

- **Google Docs**: Shows full names and emails of collaborators
- **Slack**: Shows emails of workspace members
- **Calendly**: Shows inviter email in invitations
- **Doodle**: Shows participant names/emails in polls

Tour Planner follows similar patterns for collaborative planning tools.

### Trust-Based vs. Anonymous Model

**Tour Planner uses a trust-based model:**
- Users invite known contacts
- Real identities build accountability
- Email visibility is intentional

**Not designed for anonymous use:**
- Public tours with strangers (not supported)
- Anonymous voting or participation (not supported)
- Hiding identity from co-participants (not supported)

### Future Considerations

Potential privacy enhancements for future versions:

- **Privacy Levels**: Option to hide email from co-participants (owner always sees)
- **Anonymous Participation**: Allow participation without email visibility (owner approval required)
- **In-App Messaging**: Reduce need for email-based communication
- **Pseudonym Support**: Allow users to use nicknames instead of emails

These features are not currently prioritized due to the trust-based nature of group trip planning.

## User Control

### What Users Can Control

1. **Display Name**: Set a preferred name to reduce email prominence
2. **Avatar**: Upload a profile picture for visual identification
3. **Tour Participation**: Join or leave tours at will
4. **Comment Visibility**: Edit or delete your own comments
5. **Account Deletion**: Permanently delete account and data

### What Users Cannot Control

1. **Email Visibility to Co-Participants**: Email is always visible within tours
2. **Past Comments**: Deleted accounts leave anonymized comments (cannot be fully removed)
3. **Invitation History**: Tour owners retain invitation records (for audit)

### Account Deletion

When you delete your account (via Settings → Delete Account):

#### Immediate Deletion

- User profile (display name, avatar, preferences)
- Avatar file from Supabase Storage
- Tour activity records
- Auth credentials (email, password)

#### Anonymized

- **Comments you authored**: Marked as "Anonymized User" (content preserved for tour history)
- **Tour ownership**: Transferred to another participant (if any remain)

#### Cascade Deleted

- Participation records
- Votes
- Invitations sent/received

**Note:** Account deletion is **permanent and irreversible**. You will need to create a new account to use Tour Planner again.

See `src/lib/services/profile.service.ts` (`deleteAccount` method) for implementation details.

## Data Retention

- **Active Accounts**: Data retained indefinitely while account is active
- **Deleted Accounts**: Profile and auth data deleted immediately, comments anonymized
- **Invitations**: Expired invitations retained for audit (can be manually deleted by tour owner)
- **Tours**: Tours archived by owner are retained but marked read-only
- **Database Backups**: Supabase maintains automatic backups according to their retention policy

## Data Processing and Storage

### Where Data Is Stored

- **Database**: Supabase PostgreSQL (hosted by Supabase)
- **Authentication**: Supabase Auth service
- **File Storage**: Supabase Storage (for avatars)
- **Email Delivery**: Resend (for invitation and magic link emails)

### Data Encryption

- **In Transit**: All data transmitted over HTTPS (TLS 1.2+)
- **At Rest**: Database encryption managed by Supabase
- **Passwords**: Not stored (passwordless authentication via magic links)

### Third-Party Services

Tour Planner uses the following third-party services:

1. **Supabase** (Database, Auth, Storage)
   - Purpose: Core application infrastructure
   - Data shared: All user data, tour data, comments, votes
   - Privacy policy: https://supabase.com/privacy

2. **Resend** (Email Service)
   - Purpose: Sending invitation and magic link emails
   - Data shared: Email addresses, invitation details
   - Privacy policy: https://resend.com/privacy

### Data Sharing

Tour Planner **does not** sell, rent, or share your data with third parties for marketing purposes.

Data is only shared with third-party services listed above as necessary to provide the service.

## Your Rights

Depending on your location, you may have certain rights regarding your personal data:

### Right to Access

You can access your profile data at any time through the Settings page.

### Right to Rectification

You can update your display name, avatar, and preferences through the Settings page.

### Right to Erasure

You can delete your account permanently through Settings → Delete Account.

### Right to Data Portability

Currently, there is no automated data export feature. Contact us if you need a copy of your data.

### Right to Withdraw Consent

You can stop using the service at any time by deleting your account.

## Security Measures

Tour Planner implements multiple security measures to protect your data:

1. **Row-Level Security (RLS)**: Database-level access control
2. **HTTPS Only**: All traffic encrypted in transit
3. **Rate Limiting**: Prevents brute-force attacks and abuse
4. **CSRF Protection**: Protects against cross-site request forgery
5. **Input Validation**: All user inputs validated before processing
6. **Secure Sessions**: HttpOnly cookies, automatic token refresh
7. **No Password Storage**: Passwordless authentication via magic links

See `docs/SECURITY.md` for detailed security documentation.

## Changes to This Policy

We may update this privacy policy from time to time. Changes will be reflected in the document with an updated "Last Modified" date.

Significant changes will be communicated through:
- In-app notifications
- Email to registered users
- Notice on the website

**Last Modified:** December 9, 2024

## Questions or Concerns?

If you have questions about data handling or privacy:

- **Email**: [Contact email to be added]
- **Security Issues**: See `docs/SECURITY.md` for reporting security vulnerabilities
- **Source Code**: This is an open-source project - review the code at [Repository URL]

## Children's Privacy

Tour Planner is not intended for use by children under 13 years of age. We do not knowingly collect personal information from children under 13.

If you believe a child under 13 has provided us with personal information, please contact us so we can delete it.

## International Users

Tour Planner is operated from [Country]. By using the service, you consent to the transfer of your data to [Country] and processing according to this privacy policy.

## Legal Basis for Processing (GDPR)

For users in the European Economic Area (EEA), our legal basis for processing your data is:

1. **Consent**: You consent by creating an account and using the service
2. **Contractual Necessity**: Processing is necessary to provide the service
3. **Legitimate Interest**: We have a legitimate interest in preventing fraud and improving the service

You can withdraw consent at any time by deleting your account.

## Contact Information

For privacy-related questions or concerns:

- **Data Protection Officer**: [Contact to be added]
- **Email**: [Contact email to be added]
- **Address**: [Address to be added]
